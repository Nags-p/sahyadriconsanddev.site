<!DOCTYPE html>
<html lang="en">
<head>
    <link href="images/logo.png" rel="icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyadri Promotions Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            background: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 480px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 30px;
        }
        label {
            font-weight: 600;
            font-size: 14px;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }
        input[type="password"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex-grow: 1;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #btn-send-campaign { background-color: #8D6E63; }
        #btn-send-campaign:hover:not(:disabled) { background-color: #795548; }
        #btn-send-test { background-color: #607D8B; }
        #btn-send-test:hover:not(:disabled) { background-color: #546E7A; }
        #dashboard-section { display: none; }
        .status-message {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
            padding: 10px;
            border-radius: 5px;
            display: none;
            word-break: break-word;
        }
        .status-message.success { color: #2e6b2e; background-color: #dff0d8; }
        .status-message.error { color: #a94442; background-color: #f2dede; }
        .loader {
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
            color: #555;
            display: none;
        }
        /* Styles for Segment Checkboxes */
        .segment-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 120px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        .checkbox-item {
            display: block;
            position: relative;
            padding-left: 30px;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-item:last-child { margin-bottom: 0; }
        .checkbox-item input { position: absolute; opacity: 0; cursor: pointer; }
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .checkbox-item:hover input ~ .checkmark { background-color: #ccc; }
        .checkbox-item input:checked ~ .checkmark { background-color: #8D6E63; }
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .checkbox-item input:checked ~ .checkmark:after { display: block; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Promotions Dashboard</h1>

        <!-- Login Section -->
        <div id="login-section">
            <form id="login-form">
                <label for="password">Enter Password</label>
                <input type="password" id="password" required>
                <div class="button-group" style="margin-top:10px;"><button type="submit">Login</button></div>
                <div id="login-status" class="status-message"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <form id="campaign-form">
                <label for="template-list">1. Select Email Template</label>
                <select id="template-list" name="template" required><option value="" disabled selected>Loading...</option></select>
                
                <label for="segment-container">2. Select Segments to Target</label>
                <div id="segment-container" class="segment-container">
                    <!-- Checkboxes will be dynamically inserted here -->
                </div>

                <div class="button-group">
                    <button type="button" id="btn-send-test">Send Test</button>
                    <button type="submit" id="btn-send-campaign">Send Campaign</button>
                </div>
                <div class="loader" id="campaign-loader"></div>
                <div id="campaign-status" class="status-message"></div>
            </form>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztocQ8b1iBQRTsSF1_ERZnMbTY84sNGtv3VHweclBhObBTmVTUbAKRTvRwxlekyZOT/exec';

    // --- DOM ELEMENTS ---
    const loginSection = document.getElementById('login-section'), dashboardSection = document.getElementById('dashboard-section'),
          loginForm = document.getElementById('login-form'), campaignForm = document.getElementById('campaign-form'),
          loginStatus = document.getElementById('login-status'), campaignStatus = document.getElementById('campaign-status'),
          campaignLoader = document.getElementById('campaign-loader'), templateList = document.getElementById('template-list'),
          segmentContainer = document.getElementById('segment-container'), btnSendTest = document.getElementById('btn-send-test'),
          btnSendCampaign = document.getElementById('btn-send-campaign');

    // --- API CALLER ---
    function callApi(action, payload, callback) {
        setLoading(true);
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { setLoading(false); callback(data); document.body.removeChild(document.getElementById(callbackName)); delete window[callbackName]; };
        const scriptTag = document.createElement('script'); scriptTag.id = callbackName;
        scriptTag.src = `${SCRIPT_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${callbackName}`;
        scriptTag.onerror = () => { setLoading(false); callback({success: false, message: "Network Error: Failed to contact the API."}); };
        document.body.appendChild(scriptTag);
    }
    
    function setLoading(isLoading) {
        btnSendTest.disabled = isLoading;
        btnSendCampaign.disabled = isLoading;
    }

    // --- UI POPULATION ---
    function populateCheckboxes(segments = []) {
        segmentContainer.innerHTML = ''; // Clear previous
        createCheckbox('All', 'All Customers', true);
        if (segments.length > 0) {
            segments.forEach(segment => createCheckbox(segment, segment));
        }
        segmentContainer.addEventListener('change', handleSegmentChange);
    }
    
    function createCheckbox(value, text, checked = false) {
        const label = document.createElement('label'); label.className = 'checkbox-item';
        const input = document.createElement('input'); input.type = 'checkbox'; input.value = value; input.checked = checked;
        const span = document.createElement('span'); span.className = 'checkmark';
        label.appendChild(input); label.appendChild(document.createTextNode(` ${text}`)); label.appendChild(span);
        segmentContainer.appendChild(label);
    }

    // --- EVENT HANDLERS ---
    function handleSegmentChange(e) {
        const allCheckbox = segmentContainer.querySelector('input[value="All"]');
        const otherCheckboxes = Array.from(segmentContainer.querySelectorAll('input:not([value="All"])'));
        if (e.target.value === 'All') {
            otherCheckboxes.forEach(cb => cb.checked = e.target.checked);
        } else {
            allCheckbox.checked = otherCheckboxes.length > 0 && otherCheckboxes.every(cb => cb.checked);
        }
    }

    function getSelectedSegments() {
        if (segmentContainer.querySelector('input[value="All"]').checked) { return ['All']; }
        return Array.from(segmentContainer.querySelectorAll('input:not([value="All"]):checked')).map(cb => cb.value);
    }

    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loginStatus.style.display = 'none';
        callApi('checkPassword', { password: password.value }, function(response) {
            if (response.success) {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                // Fetch all initial data needed for the dashboard
                callApi('getInitialData', {}, function(data) {
                    // Populate templates
                    templateList.innerHTML = '';
                    if (data.success && data.templates && data.templates.length > 0) {
                        data.templates.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t.replace('.html','').replace(/[-_]/g,' '); templateList.appendChild(opt); });
                    } else { templateList.innerHTML = '<option value="" disabled selected>Error fetching templates.</option>'; }
                    // Populate segments
                    populateCheckboxes(data.segments);
                });
            } else {
                loginStatus.textContent = 'Incorrect password.';
                loginStatus.className = 'status-message error';
                loginStatus.style.display = 'block';
            }
        });
    });

    btnSendTest.addEventListener('click', function() {
        const templateName = templateList.value;
        if (!templateName) { alert('Please select a template to test.'); return; }
        campaignStatus.style.display = 'none';
        campaignLoader.textContent = 'Sending test email...';
        campaignLoader.style.display = 'block';
        callApi('sendTest', { templateName: templateName }, function(response) {
            campaignLoader.style.display = 'none';
            campaignStatus.textContent = response.message;
            campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            campaignStatus.style.display = 'block';
        });
    });

    campaignForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const templateName = templateList.value;
        const selectedSegments = getSelectedSegments();
        if (!templateName) { alert('Please select a template.'); return; }
        if (selectedSegments.length === 0) { alert('Please select at least one segment to target.'); return; }
        
        const segmentText = selectedSegments.includes('All') ? "All Customers" : `${selectedSegments.length} segment(s)`;
        if (!confirm(`Are you sure you want to send the campaign "${templateName}" to ${segmentText}?`)) return;
        
        campaignStatus.style.display = 'none';
        campaignLoader.textContent = 'Sending campaign... This may take a while.';
        campaignLoader.style.display = 'block';
        callApi('runCampaign', { templateName: templateName, segments: selectedSegments }, function(response) {
            campaignLoader.style.display = 'none';
            campaignStatus.textContent = response.message;
            campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            campaignStatus.style.display = 'block';
        });
    });
</script>

</body>
</html>