<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyadri Promotions Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f9f9f9; display: flex; justify-content: center; align-items: center; padding: 40px 20px; min-height: 100vh; box-sizing: border-box; }
        .container { background: #fff; padding: 30px 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 550px; }
        h1 { text-align: center; color: #333; margin-top: 0; margin-bottom: 30px; }
        h2 { font-size: 16px; color: #333; border-bottom: 2px solid #8D6E63; padding-bottom: 8px; margin-top: 25px; margin-bottom: 20px;}
        label { font-weight: 600; font-size: 14px; color: #555; display: block; margin-bottom: 8px; }
        input[type="text"], input[type="url"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; margin-bottom: 15px; font-family: 'Montserrat', sans-serif;}
        textarea { height: 120px; resize: vertical; }
        .button-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex-grow: 1; padding: 12px; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* CORRECTED BUTTON STYLES */
        .btn-primary { background-color: #8D6E63; }
        .btn-primary:hover:not(:disabled) { background-color: #795548; }
        .btn-secondary { background-color: #607D8B; }
        .btn-secondary:hover:not(:disabled) { background-color: #546E7A; }
        .btn-info { background-color: #03A9F4; }
        .btn-info:hover:not(:disabled) { background-color: #0288D1; }

        #dashboard-section { display: none; }
        .status-message { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 600; padding: 10px; border-radius: 5px; display: none; word-break: break-word; }
        .status-message.success { color: #2e6b2e; background-color: #dff0d8; } .status-message.error { color: #a94442; background-color: #f2dede; }
        .loader { text-align: center; margin-top: 15px; font-weight: 600; color: #555; display: none; }
        .segment-container { border: 1px solid #ddd; border-radius: 5px; padding: 15px; max-height: 120px; overflow-y: auto; background-color: #fafafa; }
        .checkbox-item { display: block; position: relative; padding-left: 30px; margin-bottom: 10px; cursor: pointer; user-select: none; }
        .checkbox-item:last-child { margin-bottom: 0; }
        .checkbox-item input { position: absolute; opacity: 0; cursor: pointer; }
        .checkmark { position: absolute; top: 0; left: 0; height: 20px; width: 20px; background-color: #eee; border: 1px solid #ccc; border-radius: 3px; transition: background-color 0.2s; }
        .checkbox-item:hover input ~ .checkmark { background-color: #ccc; }
        .checkbox-item input:checked ~ .checkmark { background-color: #8D6E63; }
        .checkmark:after { content: ""; position: absolute; display: none; left: 7px; top: 3px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .checkbox-item input:checked ~ .checkmark:after { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Promotions Dashboard</h1>
        <div id="login-section">
            <form id="login-form">
                <label for="password">Enter Password</label>
                <input type="password" id="password" required>
                <!-- CORRECTED LOGIN BUTTON with a primary style -->
                <div class="button-group" style="margin-top:10px;"><button type="submit" class="btn-primary">Login</button></div>
                <div id="login-status" class="status-message"></div>
            </form>
        </div>
        <div id="dashboard-section">
            <form id="campaign-form">
                <h2>1. Compose Your Email</h2>
                <label for="c-subject">Email Subject</label>
                <input type="text" id="c-subject" placeholder="e.g., Exclusive Offer on Our New Sky Residences" required>
                <label for="c-headline">Headline</label>
                <input type="text" id="c-headline" placeholder="e.g., Your Dream Home Awaits" required>
                <label for="c-image-url">Main Image URL</label>
                <input type="url" id="c-image-url" placeholder="https://i.imgur.com/your-image.jpg" required>
                <label for="c-body">Body Text</label>
                <textarea id="c-body" placeholder="Write the main content of your email here..." required></textarea>
                <label for="c-cta-text">Button Text</label>
                <input type="text" id="c-cta-text" value="Learn More" required>
                <label for="c-cta-link">Button Link (URL)</label>
                <input type="url" id="c-cta-link" placeholder="https://your-website.com/project" required>
                
                <h2>2. Select Segments to Target</h2>
                <div id="segment-container" class="segment-container"></div>

                <div class="button-group">
                    <button type="button" id="btn-preview" class="btn-info">Preview</button>
                    <button type="button" id="btn-send-test" class="btn-secondary">Send Test</button>
                    <button type="submit" id="btn-send-campaign" class="btn-primary">Send Campaign</button>
                </div>
                <div class="loader" id="campaign-loader"></div>
                <div id="campaign-status" class="status-message"></div>
            </form>
        </div>
    </div>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztocQ8b1iBQRTsSF1_ERZnMbTY84sNGtv3VHweclBhObBTmVTUbAKRTvRwxlekyZOT/exec';
    let masterTemplateHtml = ''; // This will store the template for instant previews
    
    // --- DOM Elements ---
    const loginSection = document.getElementById('login-section'), dashboardSection = document.getElementById('dashboard-section'),
          loginForm = document.getElementById('login-form'), campaignForm = document.getElementById('campaign-form'),
          loginStatus = document.getElementById('login-status'), campaignStatus = document.getElementById('campaign-status'),
          campaignLoader = document.getElementById('campaign-loader'), segmentContainer = document.getElementById('segment-container'),
          btnPreview = document.getElementById('btn-preview'), btnSendTest = document.getElementById('btn-send-test'),
          btnSendCampaign = document.getElementById('btn-send-campaign');

    // --- API Caller & Loading State ---
    function callApi(action, payload, callback) {
        setLoading(true);
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { setLoading(false); callback(data); document.body.removeChild(document.getElementById(callbackName)); delete window[callbackName]; };
        const scriptTag = document.createElement('script'); scriptTag.id = callbackName;
        scriptTag.src = `${SCRIPT_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${callbackName}`;
        scriptTag.onerror = () => { setLoading(false); callback({success: false, message: "Network Error: Failed to contact the API."}); };
        document.body.appendChild(scriptTag);
    }
    
    function setLoading(isLoading) {
        btnPreview.disabled = isLoading;
        btnSendTest.disabled = isLoading;
        btnSendCampaign.disabled = isLoading;
        campaignLoader.style.display = isLoading ? 'block' : 'none';
    }

    // --- UI Population & Helpers ---
    function populateCheckboxes(segments = []) {
        segmentContainer.innerHTML = '';
        createCheckbox('All', 'All Customers', true);
        if (segments.length > 0) { segments.forEach(segment => createCheckbox(segment, segment)); }
        segmentContainer.addEventListener('change', handleSegmentChange);
    }
    
    function createCheckbox(value, text, checked = false) {
        const label = document.createElement('label'); label.className = 'checkbox-item';
        const input = document.createElement('input'); input.type = 'checkbox'; input.value = value; input.checked = checked;
        const span = document.createElement('span'); span.className = 'checkmark';
        label.appendChild(input); label.appendChild(document.createTextNode(` ${text}`)); label.appendChild(span);
        segmentContainer.appendChild(label);
    }

    function handleSegmentChange(e) {
        const allCheckbox = segmentContainer.querySelector('input[value="All"]');
        const otherCheckboxes = Array.from(segmentContainer.querySelectorAll('input:not([value="All"])'));
        if (e.target.value === 'All') {
            otherCheckboxes.forEach(cb => cb.checked = e.target.checked);
        } else {
            allCheckbox.checked = otherCheckboxes.length > 0 && otherCheckboxes.every(cb => cb.checked);
        }
    }

    function getSelectedSegments() {
        if (segmentContainer.querySelector('input[value="All"]').checked) { return ['All']; }
        return Array.from(segmentContainer.querySelectorAll('input:not([value="All"]):checked')).map(cb => cb.value);
    }
    
    function getCampaignData() {
        return {
            subject: document.getElementById('c-subject').value,
            headline: document.getElementById('c-headline').value,
            image_url: document.getElementById('c-image-url').value,
            body_text: document.getElementById('c-body').value,
            cta_text: document.getElementById('c-cta-text').value,
            cta_link: document.getElementById('c-cta-link').value
        };
    }

    // --- Event Listeners ---
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loginStatus.style.display = 'none';
        campaignLoader.textContent = 'Logging in...';
        callApi('checkPassword', { password: password.value }, function(response) {
            if (response.success) {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                campaignLoader.textContent = 'Fetching dashboard data...';
                // Fetch segments and master template on successful login
                callApi('getDashboardData', {}, function(data) {
                    if (data.success) {
                        masterTemplateHtml = data.templateHtml; // Store the template
                        populateCheckboxes(data.segments);
                    } else {
                        alert('Error fetching dashboard data: ' + (data.message || 'Unknown error'));
                    }
                });
            } else {
                loginStatus.textContent = 'Incorrect password.';
                loginStatus.className = 'status-message error';
                loginStatus.style.display = 'block';
            }
        });
    });

    btnPreview.addEventListener('click', function() {
        if (!campaignForm.checkValidity()) {
            alert('Please fill out all email content fields to generate a preview.');
            campaignForm.reportValidity();
            return;
        }
        if (!masterTemplateHtml) { alert('Master template has not loaded yet. Please wait a moment.'); return; }
        const campaignData = getCampaignData();
        const composedHtml = masterTemplateHtml
            .replace(/{{headline}}/g, campaignData.headline)
            .replace(/{{image_url}}/g, campaignData.image_url)
            .replace(/{{body_text}}/g, campaignData.body_text.replace(/\n/g, '<br>'))
            .replace(/{{cta_text}}/g, campaignData.cta_text)
            .replace(/{{cta_link}}/g, campaignData.cta_link)
            .replace(/{{unsubscribe_link_text}}/g, 'This is a preview. The unsubscribe link will be active in real emails.');
        
        const previewWindow = window.open('', '_blank');
        previewWindow.document.write(composedHtml);
        previewWindow.document.close();
    });

    btnSendTest.addEventListener('click', function() {
        if (!campaignForm.checkValidity()) { campaignForm.reportValidity(); alert('Please fill out all email content fields.'); return; }
        const campaignData = getCampaignData();
        campaignStatus.style.display = 'none';
        campaignLoader.textContent = 'Sending test email...';
        callApi('sendTest', { campaignData: campaignData }, function(response) {
            campaignStatus.textContent = response.message;
            campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            campaignStatus.style.display = 'block';
        });
    });

    campaignForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedSegments = getSelectedSegments();
        if (selectedSegments.length === 0) { alert('Please select at least one segment to target.'); return; }
        const campaignData = getCampaignData();
        const segmentText = selectedSegments.includes('All') ? "All Customers" : `${selectedSegments.length} segment(s)`;
        if (!confirm(`Are you sure you want to send this campaign to ${segmentText}?`)) return;
        campaignStatus.style.display = 'none';
        campaignLoader.textContent = 'Sending campaign... This may take a while.';
        callApi('runCampaign', { campaignData: campaignData, segments: selectedSegments }, function(response) {
            campaignStatus.textContent = response.message;
            campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            campaignStatus.style.display = 'block';
        });
    });
</script>

</body>
</html>