<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyadri Promotions Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f9f9f9; display: flex; justify-content: center; align-items: center; padding: 40px 20px; min-height: 100vh; box-sizing: border-box; }
        .container { background: #fff; padding: 30px 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 550px; }
        h1 { text-align: center; color: #333; margin-top: 0; margin-bottom: 30px; }
        h2 { font-size: 16px; color: #333; border-bottom: 2px solid #8D6E63; padding-bottom: 8px; margin-top: 25px; margin-bottom: 20px;}
        label { font-weight: 600; font-size: 14px; color: #555; display: block; margin-bottom: 8px; }
        input[type="text"], input[type="url"], input[type="password"], textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; margin-bottom: 15px; font-family: 'Montserrat', sans-serif;}
        .link-input-group { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; }
        .link-prefix { padding: 12px; background-color: #f7f7f7; color: #666; font-size: 14px; border-right: 1px solid #ddd; white-space: nowrap; }
        #c-cta-path { border: none; flex-grow: 1; margin-bottom: 0; }
        #c-cta-path:focus { outline: none; box-shadow: none; }
        textarea { height: 120px; resize: vertical; }
        .button-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex-grow: 1; padding: 12px; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-primary { background-color: #8D6E63; }
        .btn-primary:hover:not(:disabled) { background-color: #795548; }
        .btn-secondary { background-color: #607D8B; }
        .btn-secondary:hover:not(:disabled) { background-color: #546E7A; }
        .btn-info { background-color: #03A9F4; }
        .btn-info:hover:not(:disabled) { background-color: #0288D1; }
        #dashboard-section { display: none; }
        .status-message { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 600; padding: 10px; border-radius: 5px; display: none; word-break: break-word; }
        .status-message.success { color: #2e6b2e; background-color: #dff0d8; }
        .status-message.error { color: #a94442; background-color: #f2dede; }
        .loader { text-align: center; margin-top: 15px; font-weight: 600; color: #555; display: none; }
        .segment-container { border: 1px solid #ddd; border-radius: 5px; padding: 15px; max-height: 120px; overflow-y: auto; background-color: #fafafa; }
        .checkbox-item { display: block; position: relative; padding-left: 30px; margin-bottom: 10px; cursor: pointer; user-select: none; }
        .checkbox-item:last-child { margin-bottom: 0; }
        .checkbox-item input { position: absolute; opacity: 0; cursor: pointer; }
        .checkmark { position: absolute; top: 0; left: 0; height: 20px; width: 20px; background-color: #eee; border: 1px solid #ccc; border-radius: 3px; transition: background-color 0.2s; }
        .checkbox-item:hover input ~ .checkmark { background-color: #ccc; }
        .checkbox-item input:checked ~ .checkmark { background-color: #8D6E63; }
        .checkmark:after { content: ""; position: absolute; display: none; left: 7px; top: 3px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .checkbox-item input:checked ~ .checkmark:after { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Promotions Dashboard</h1>
        <div id="login-section">
            <form id="login-form">
                <label for="password">Enter Password</label>
                <input type="password" id="password" required>
                <div class="button-group" style="margin-top:10px;"><button type="submit" class="btn-primary">Login</button></div>
                <div id="login-status" class="status-message"></div>
            </form>
        </div>
        <div id="dashboard-section">
            <form id="campaign-form">
                <h2>1. Compose Your Email</h2>
                <label for="c-subject">Email Subject</label>
                <input type="text" id="c-subject" placeholder="e.g., Exclusive Offer on Our New Sky Residences" required>
                <label for="c-headline">Headline</label>
                <input type="text" id="c-headline" placeholder="e.g., Your Dream Home Awaits" required>
                <label for="c-image-list">Main Image</label>
                <select id="c-image-list" required><option value="" disabled selected>Loading images...</option></select>
                <label for="c-body">Body Text</label>
                <textarea id="c-body" placeholder="Write the main content of your email here..." required></textarea>
                <label for="c-cta-text">Button Text</label>
                <input type="text" id="c-cta-text" value="Learn More" required>
                <label for="c-cta-path">Button Link</label>
                <div class="link-input-group">
                    <span class="link-prefix">https://www.sahyadriconstructionsanddevelopers.great-site.net/</span>
                    <input type="text" id="c-cta-path" placeholder="contact.html" required>
                </div>

                <h2>2. Select Segments to Target</h2>
                <div id="segment-container" class="segment-container"></div>

                <div class="button-group">
                    <button type="button" id="btn-preview" class="btn-info">Preview</button>
                    <button type="button" id="btn-send-test" class="btn-secondary">Send Test</button>
                    <button type="submit" id="btn-send-campaign" class="btn-primary">Send Campaign</button>
                </div>
                <div class="loader" id="campaign-loader"></div>
                <div id="campaign-status" class="status-message"></div>
            </form>
        </div>
    </div>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztocQ8b1iBQRTsSF1_ERZnMbTY84sNGtv3VHweclBhObBTmVTUbAKRTvRwxlekyZOT/exec';
    const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Nags-p/sahyadriconsanddev.site/main/images/promotion/';
    const WEBSITE_BASE_URL = 'https://www.sahyadriconstructionsanddevelopers.great-site.net/';
    let masterTemplateHtml = '';
    
    const allDOMElements = { loginSection: document.getElementById('login-section'), dashboardSection: document.getElementById('dashboard-section'), loginForm: document.getElementById('login-form'), campaignForm: document.getElementById('campaign-form'), loginStatus: document.getElementById('login-status'), campaignStatus: document.getElementById('campaign-status'), campaignLoader: document.getElementById('campaign-loader'), segmentContainer: document.getElementById('segment-container'), imageList: document.getElementById('c-image-list'), btnPreview: document.getElementById('btn-preview'), btnSendTest: document.getElementById('btn-send-test'), btnSendCampaign: document.getElementById('btn-send-campaign') };

    function callApi(action, payload, callback) {
        setLoading(true);
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { setLoading(false); callback(data); document.body.removeChild(document.getElementById(callbackName)); delete window[callbackName]; };
        const scriptTag = document.createElement('script'); scriptTag.id = callbackName;
        scriptTag.src = `${SCRIPT_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${callbackName}`;
        scriptTag.onerror = () => { setLoading(false); callback({success: false, message: "Network Error: Failed to contact the API."}); };
        document.body.appendChild(scriptTag);
    }
    
    function setLoading(isLoading) {
        Object.values(allDOMElements).filter(el => el.tagName === 'BUTTON').forEach(btn => btn.disabled = isLoading);
        allDOMElements.campaignLoader.style.display = isLoading ? 'block' : 'none';
    }

    function populateCheckboxes(segments = []) {
        allDOMElements.segmentContainer.innerHTML = '';
        createCheckbox('All', 'All Customers', true);
        if (segments.length > 0) { segments.forEach(segment => createCheckbox(segment, segment)); }
        allDOMElements.segmentContainer.addEventListener('change', handleSegmentChange);
    }
    
    function createCheckbox(value, text, checked = false) {
        const label = document.createElement('label'); label.className = 'checkbox-item';
        const input = document.createElement('input'); input.type = 'checkbox'; input.value = value; input.checked = checked;
        const span = document.createElement('span'); span.className = 'checkmark';
        label.appendChild(input); label.appendChild(document.createTextNode(` ${text}`)); label.appendChild(span);
        allDOMElements.segmentContainer.appendChild(label);
    }

    function populateImages(images = []) {
        const list = allDOMElements.imageList;
        list.innerHTML = '';
        if (images.length === 0) {
            list.innerHTML = '<option value="" disabled selected>No images found in repo.</option>';
        } else {
            images.forEach(img => {
                const opt = document.createElement('option'); opt.value = img; opt.textContent = img; list.appendChild(opt);
            });
        }
    }

    function handleSegmentChange(e) {
        const allCheckbox = allDOMElements.segmentContainer.querySelector('input[value="All"]');
        const otherCheckboxes = Array.from(allDOMElements.segmentContainer.querySelectorAll('input:not([value="All"])'));
        if (e.target.value === 'All') { otherCheckboxes.forEach(cb => cb.checked = e.target.checked); }
        else { allCheckbox.checked = otherCheckboxes.length > 0 && otherCheckboxes.every(cb => cb.checked); }
    }

    function getSelectedSegments() {
        if (allDOMElements.segmentContainer.querySelector('input[value="All"]').checked) { return ['All']; }
        return Array.from(allDOMElements.segmentContainer.querySelectorAll('input:not([value="All"]):checked')).map(cb => cb.value);
    }
    
    function getCampaignData() {
        return {
            subject: document.getElementById('c-subject').value,
            headline: document.getElementById('c-headline').value,
            image_filename: allDOMElements.imageList.value,
            body_text: document.getElementById('c-body').value,
            cta_text: document.getElementById('c-cta-text').value,
            cta_path: document.getElementById('c-cta-path').value
        };
    }

    allDOMElements.loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        allDOMElements.campaignLoader.textContent = 'Logging in...';
        callApi('checkPassword', { password: password.value }, function(response) {
            if (response.success) {
                allDOMElements.loginSection.style.display = 'none';
                allDOMElements.dashboardSection.style.display = 'block';
                allDOMElements.campaignLoader.textContent = 'Fetching dashboard data...';
                callApi('getDashboardData', {}, function(data) {
                    if (data.success) {
                        masterTemplateHtml = data.templateHtml;
                        populateCheckboxes(data.segments);
                        populateImages(data.images);
                    } else { alert('Error fetching dashboard data: ' + (data.message || 'Unknown error')); }
                });
            } else { allDOMElements.loginStatus.textContent = 'Incorrect password.'; allDOMElements.loginStatus.className = 'status-message error'; allDOMElements.loginStatus.style.display = 'block'; }
        });
    });

    allDOMElements.btnPreview.addEventListener('click', function() {
        if (!allDOMElements.campaignForm.checkValidity()) { alert('Please fill out all fields to generate a preview.'); allDOMElements.campaignForm.reportValidity(); return; }
        if (!masterTemplateHtml) { alert('Master template has not loaded yet.'); return; }
        const campaignData = getCampaignData();
        const composedHtml = masterTemplateHtml
            .replace(/{{headline}}/g, campaignData.headline)
            .replace(/{{image_url}}/g, IMAGE_BASE_URL + campaignData.image_filename)
            .replace(/{{body_text}}/g, campaignData.body_text.replace(/\n/g, '<br>'))
            .replace(/{{cta_text}}/g, campaignData.cta_text)
            .replace(/{{cta_link}}/g, WEBSITE_BASE_URL + campaignData.cta_path)
            .replace(/{{unsubscribe_link_text}}/g, 'This is a preview. The unsubscribe link will be active in real emails.');
        const previewWindow = window.open('', '_blank');
        previewWindow.document.write(composedHtml);
        previewWindow.document.close();
    });

    allDOMElements.btnSendTest.addEventListener('click', function() {
        if (!allDOMElements.campaignForm.checkValidity()) { allDOMElements.campaignForm.reportValidity(); alert('Please fill out all email content fields.'); return; }
        const campaignData = getCampaignData();
        allDOMElements.campaignStatus.style.display = 'none';
        allDOMElements.campaignLoader.textContent = 'Sending test email...';
        callApi('sendTest', { campaignData: campaignData }, function(response) {
            allDOMElements.campaignStatus.textContent = response.message;
            allDOMElements.campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            allDOMElements.campaignStatus.style.display = 'block';
        });
    });

    allDOMElements.campaignForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedSegments = getSelectedSegments();
        if (selectedSegments.length === 0) { alert('Please select at least one segment to target.'); return; }
        const campaignData = getCampaignData();
        const segmentText = selectedSegments.includes('All') ? "All Customers" : `${selectedSegments.length} segment(s)`;
        if (!confirm(`Are you sure you want to send this campaign to ${segmentText}?`)) return;
        allDOMElements.campaignStatus.style.display = 'none';
        allDOMElements.campaignLoader.textContent = 'Sending campaign... This may take a while.';
        callApi('runCampaign', { campaignData: campaignData, segments: selectedSegments }, function(response) {
            allDOMElements.campaignStatus.textContent = response.message;
            allDOMElements.campaignStatus.className = response.success ? 'status-message success' : 'status-message error';
            allDOMElements.campaignStatus.style.display = 'block';
        });
    });
</script>
</body>
</html>